# Authentication & Group Management System Specification

## Overview

A React SPA with Convex backend implementing multi-tenant authentication, group-based permissions, and collaborative messaging. This is a skeleton/core system designed for extensibility.

**Tech Stack:**

- Frontend: React 18+, TypeScript, Vite, TanStack Router, Zustand
- Backend: Convex (database, functions, real-time)
- Auth: Convex Auth (email/password + Google OAuth + TOTP 2FA)
- Email: Resend (via Convex Auth)
- Styling: CSS Modules (minimal, browser defaults acceptable)
- Deployment: Vercel (frontend) + Convex Cloud (backend)

---

## Table of Contents

1. [Data Models & Schema](#1-data-models--schema)
2. [Authentication System](#2-authentication-system)
3. [User Management](#3-user-management)
4. [Group System](#4-group-system)
5. [Permissions & Roles](#5-permissions--roles)
6. [Invitation System](#6-invitation-system)
7. [Messaging (Demo Feature)](#7-messaging-demo-feature)
8. [Audit Logging](#8-audit-logging)
9. [Super-Admin System](#9-super-admin-system)
10. [Route Protection](#10-route-protection)
11. [URL Structure & Navigation](#11-url-structure--navigation)
12. [Project Structure](#12-project-structure)
13. [Implementation Phases](#13-implementation-phases)
14. [Future Considerations](#14-future-considerations)

---

## 1. Data Models & Schema

### 1.1 Users Table

```typescript
// convex/schema.ts
users: defineTable({
  // Convex Auth fields (managed automatically)
  email: v.string(),
  emailVerified: v.boolean(),

  // Password hash stored by Convex Auth separately

  // Profile
  deletedAt: v.optional(v.number()), // Soft delete timestamp
  deletedUserId: v.optional(v.string()), // "Deleted User {uniqueId}" replacement

  // 2FA
  totpSecret: v.optional(v.string()), // Encrypted TOTP secret
  totpEnabled: v.boolean(),

  // System
  isSuperAdmin: v.boolean(), // Manually set in DB
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_email", ["email"])
  .index("by_deleted", ["deletedAt"]);
```

### 1.2 Groups Table

```typescript
groups: defineTable({
  name: v.string(),
  createdAt: v.number(),
  createdBy: v.id("users"),

  // Soft delete
  deletedAt: v.optional(v.number()),
  deletedBy: v.optional(v.id("users")),
})
  .index("by_deleted", ["deletedAt"])
  .index("by_creator", ["createdBy"]);
```

### 1.3 Group Memberships Table

```typescript
// Role enum: "admin" | "editor" | "viewer" | "removed"
groupMemberships: defineTable({
  groupId: v.id("groups"),
  userId: v.id("users"),
  role: v.string(), // "admin" | "editor" | "viewer" | "removed"
  joinedAt: v.number(),
  updatedAt: v.number(),
  updatedBy: v.id("users"), // Who last changed the role
})
  .index("by_group", ["groupId"])
  .index("by_user", ["userId"])
  .index("by_group_user", ["groupId", "userId"])
  .index("by_group_role", ["groupId", "role"]);
```

### 1.4 Invitations Table

```typescript
invitations: defineTable({
  groupId: v.id("groups"),
  email: v.string(), // Invitee email (may or may not be registered)
  invitedBy: v.id("users"),
  createdAt: v.number(),
  status: v.string(), // "pending" | "accepted" | "revoked"
  acceptedAt: v.optional(v.number()),
  acceptedBy: v.optional(v.id("users")),
})
  .index("by_group", ["groupId"])
  .index("by_email", ["email"])
  .index("by_group_email", ["groupId", "email"])
  .index("by_status", ["status"]);
```

### 1.5 Messages Table

```typescript
messages: defineTable({
  groupId: v.id("groups"),
  authorId: v.id("users"),
  content: v.string(), // Max 500 characters, plain text
  createdAt: v.number(),
})
  .index("by_group", ["groupId"])
  .index("by_group_created", ["groupId", "createdAt"])
  .index("by_author", ["authorId"]);
```

### 1.6 Audit Logs Table

```typescript
auditLogs: defineTable({
  groupId: v.id("groups"),
  actorId: v.id("users"), // Who performed the action
  targetId: v.optional(v.id("users")), // Affected user (if applicable)
  action: v.string(), // See action types below
  details: v.optional(v.string()), // JSON string with additional context
  createdAt: v.number(),
})
  .index("by_group", ["groupId"])
  .index("by_group_created", ["groupId", "createdAt"])
  .index("by_actor", ["actorId"]);

// Action types:
// - "member_invited"
// - "member_joined"
// - "member_left"
// - "member_removed"
// - "role_changed"
// - "invite_revoked"
// - "group_soft_deleted"
// - "group_restored"
```

---

## 2. Authentication System

### 2.1 Registration Flow

1. User submits email + password
2. **Password validation:**
   - Minimum 12 characters
   - At least one letter (a-z, A-Z)
   - At least one number (0-9)
   - At least one symbol (!@#$%^&\*etc)
3. Create user record with `emailVerified: false`
4. Send verification email via Resend
5. User cannot log in until email verified
6. On verification link click, set `emailVerified: true`
7. Check for pending invitations by email, auto-accept them

### 2.2 Login Flow

1. User submits email + password
2. Validate credentials via Convex Auth
3. Check `emailVerified === true`, reject if false
4. Check if user is soft-deleted, reject if true
5. If TOTP enabled, prompt for 2FA code
6. Validate TOTP code if required
7. Issue session (multi-device supported)

### 2.3 Google OAuth Flow

1. User clicks "Sign in with Google"
2. Redirect to Google OAuth consent
3. On callback, check if email exists in system:
   - **New email:** Create account, mark email as verified
   - **Existing email (same provider):** Log in normally
   - **Existing email (different provider):** Prompt to link accounts
4. Account linking requires password confirmation from existing account
5. After linking, both methods can be used for login
6. Check for pending invitations, auto-accept them

### 2.4 Forgot Password Flow

1. User submits email on forgot password page
2. If email exists and verified, send reset link via Resend
3. Reset link contains secure token (Convex Auth managed)
4. Link does NOT require 2FA (convenience over security decision)
5. User sets new password (same validation rules)
6. All existing sessions remain valid (no forced logout)

### 2.5 Password Change Flow (Authenticated)

1. User must provide current password
2. User provides new password
3. Validate current password
4. Validate new password meets requirements
5. Update password

### 2.6 Two-Factor Authentication (TOTP)

**Setup:**

1. User navigates to security settings
2. User confirms current password
3. Generate TOTP secret, display QR code
4. User scans with authenticator app (Google Authenticator, Authy, etc.)
5. User enters verification code to confirm setup
6. Store encrypted secret, set `totpEnabled: true`

**Login with 2FA:**

1. After email/password validation, check `totpEnabled`
2. If true, show TOTP input screen
3. Validate 6-digit code against secret
4. Allow login on success

**Disable 2FA:**

1. User confirms current password
2. User enters current TOTP code
3. Clear secret, set `totpEnabled: false`

---

## 3. User Management

### 3.1 User Profile

**Viewable fields:**

- Email (read-only display)
- 2FA status (enabled/disabled)
- Account created date
- List of groups (active + removed)

**Editable fields:**

- Password (requires current password confirmation)
- Email (requires current password confirmation) — triggers re-verification
- 2FA settings (requires current password confirmation)

### 3.2 Email Change Flow

1. User confirms current password
2. User enters new email
3. Validate email format and uniqueness
4. Send verification to NEW email
5. Until verified, old email remains active
6. On verification, update email, set verified

### 3.3 Account Deletion

**Prerequisites:**

- User must not be the sole admin of any group
- User must leave all groups first (removed status counts as "out")

**Process:**

1. User confirms current password
2. User confirms deletion intent (type "DELETE" or similar)
3. Soft delete: Set `deletedAt` timestamp
4. Replace identifiable data with `deletedUserId: "Deleted User {uniqueId}"`
5. Keep messages but show author as "Deleted User"
6. User cannot log in after deletion

---

## 4. Group System

### 4.1 Group Creation

1. Authenticated user creates group with name
2. System creates group record with `createdAt`, `createdBy`
3. System creates membership: creator as "admin" role
4. Log audit: "group_created"

### 4.2 Group Visibility

**For active members (admin/editor/viewer):**

- Group name
- Group messages
- Member list (based on role permissions)
- Audit log (admins only)

**For removed members:**

- Group name only
- No messages, no member list, no audit log

**For non-members:**

- No visibility (404)

### 4.3 Group Soft Delete

**Who can soft delete:**

- Any admin of the group

**Process:**

1. Admin confirms action
2. Set `deletedAt` timestamp on group
3. Set all memberships to "removed" role
4. Log audit: "group_soft_deleted"
5. Group appears in removed lists for all former members

**Recovery:**

- Only super-admins can restore
- Super-admin adds at least one admin back
- Clear `deletedAt` on group
- Log audit: "group_restored"

### 4.4 Group Hard Delete

**Who can hard delete:**

- Super-admins only

**Process:**

1. Delete all messages in group
2. Delete all memberships
3. Delete all invitations
4. Delete all audit logs
5. Delete group record

---

## 5. Permissions & Roles

### 5.1 Role Hierarchy

| Role    | View Group | View Messages | Post Messages | Manage Members | Delete Group |
| ------- | ---------- | ------------- | ------------- | -------------- | ------------ |
| Admin   | ✅         | ✅            | ✅            | ✅             | ✅           |
| Editor  | ✅         | ✅            | ✅            | ❌             | ❌           |
| Viewer  | ✅         | ✅            | ❌            | ❌             | ❌           |
| Removed | Name only  | ❌            | ❌            | ❌             | ❌           |

### 5.2 Role Change Rules

**Admins can:**

- Change any member's role to any other role
- Cannot demote themselves if they are the last admin
- Can restore "removed" users to any role

**Self-actions:**

- Any member can leave (set self to "removed")
- Exception: Last admin cannot leave

### 5.3 Permission Checks

All Convex mutations must verify:

1. User is authenticated
2. User is member of the group
3. User's role permits the action
4. Special case checks (last admin, etc.)

```typescript
// Example permission check helper
async function checkPermission(
  ctx: QueryCtx,
  userId: Id<"users">,
  groupId: Id<"groups">,
  requiredRoles: string[]
): Promise<{ allowed: boolean; membership?: Doc<"groupMemberships"> }>;
```

---

## 6. Invitation System

### 6.1 Invite Creation

**Who can invite:** Admins only

**Process:**

1. Admin enters email address
2. Check if email is already a member (any role including removed):
   - If yes: Block invite, show error "User is already a member"
   - If removed: Admin should change role instead of re-inviting
3. Check if pending invite exists for this email + group:
   - If yes: Block invite, show error "Invitation already pending"
4. Create invitation record with status "pending"
5. Send invitation email via Resend
6. Log audit: "member_invited"

### 6.2 Invite Acceptance

**Registered user:**

1. User clicks invite link
2. If logged in, accept immediately
3. If not logged in, redirect to login, then accept
4. Create membership with "viewer" role (default)
5. Update invitation status to "accepted"
6. Log audit: "member_joined"

**Unregistered user:**

1. User clicks invite link
2. Redirect to registration with invite token
3. After registration + email verification, auto-accept invite
4. Create membership with "viewer" role
5. Update invitation status to "accepted"
6. Log audit: "member_joined"

### 6.3 Invite Revocation

**Who can revoke:** Admins only (the inviter or any admin)

1. Admin clicks revoke on pending invitation
2. Set invitation status to "revoked"
3. Log audit: "invite_revoked"
4. Revoked invites cannot be accepted

### 6.4 Pending Invites View

Admins see table of all pending invitations:

- Invitee email
- Invited by (admin name)
- Invited date
- Revoke action button

---

## 7. Messaging (Demo Feature)

### 7.1 Message Creation

**Who can post:** Admins and Editors

**Validation:**

- Content required, non-empty after trim
- Maximum 500 characters
- Plain text only (no markdown, no HTML)

**Process:**

1. Validate user has permission
2. Validate content
3. Create message record
4. Real-time sync via Convex

### 7.2 Message Display

**Viewers and above see:**

- Message content
- Author display (email or "Deleted User {id}")
- Timestamp

**Removed members:**

- Cannot see messages (403/empty state)

### 7.3 Message Listing

- Ordered by `createdAt` descending (newest first)
- Paginated (20 messages per page suggested)
- Use Convex's `usePaginatedQuery` for infinite scroll

---

## 8. Audit Logging

### 8.1 Logged Events

| Action             | Details Stored                         |
| ------------------ | -------------------------------------- |
| member_invited     | `{ email, invitedBy }`                 |
| member_joined      | `{ role, viaInvite: boolean }`         |
| member_left        | `{ previousRole }`                     |
| member_removed     | `{ previousRole, removedBy }`          |
| role_changed       | `{ previousRole, newRole, changedBy }` |
| invite_revoked     | `{ email, revokedBy }`                 |
| group_soft_deleted | `{ deletedBy }`                        |
| group_restored     | `{ restoredBy }`                       |

### 8.2 Audit Log Access

**Who can view:** Admins only

**Display:**

- Timestamp
- Action type (human readable)
- Actor (who did it)
- Target (who was affected, if applicable)
- Details

---

## 9. Super-Admin System

### 9.1 Designation

Super-admins are designated by manually setting `isSuperAdmin: true` in the Convex database. No UI for promotion/demotion.

```bash
# Example: Set super admin via Convex dashboard or script
# Navigate to Convex Dashboard > Data > users > Edit document
```

### 9.2 Super-Admin Powers

**View all groups:**

- Can see all groups in system (including soft-deleted)
- Normal members only see their own groups

**Restore soft-deleted groups:**

- Can clear `deletedAt` on groups
- Must add at least one admin when restoring

**Manage any group:**

- Can change roles in any group
- Can remove users from any group
- Can add self to any group as admin

**Hard delete:**

- Can permanently delete groups
- Can permanently delete users (with all their data)

### 9.3 Super-Admin UI

No separate admin panel. Super-admins see additional UI elements:

- "All Groups" view in navigation
- "Restore" button on soft-deleted groups
- "Hard Delete" option (with confirmation)
- Role management in groups they're not members of

---

## 10. Route Protection

### 10.1 ProtectedWithRedirect Component

Redirects unauthenticated users to login page with return URL.

```typescript
// Usage
<ProtectedWithRedirect>
  <DashboardPage />
</ProtectedWithRedirect>

// Behavior
// - If not authenticated: Redirect to /login?returnTo=/current-path
// - If authenticated: Render children
// - Shows "Loading..." during auth check
```

### 10.2 ProtectedWithLogin Component

Shows inline login form instead of redirecting.

```typescript
// Usage
<ProtectedWithLogin>
  <DashboardPage />
</ProtectedWithLogin>

// Behavior
// - If not authenticated: Render login form inline
// - If authenticated: Render children
// - Shows "Loading..." during auth check
```

### 10.3 Public Routes

No wrapper needed. Pages render for all visitors.

### 10.4 Role-Based Protection

For routes requiring specific group roles:

```typescript
// Usage
<GroupRoleGuard groupId={groupId} requiredRoles={["admin", "editor"]}>
  <GroupMessagesPage />
</GroupRoleGuard>

// Behavior
// - Checks user is authenticated
// - Checks user is member of group with required role
// - Shows appropriate error/redirect if not permitted
```

---

## 11. URL Structure & Navigation

### 11.1 Routes

```
/                       # Redirect to /login or /groups based on auth
/login                  # Login page
/register               # Registration page
/forgot-password        # Forgot password page
/reset-password/:token  # Reset password page
/verify-email/:token    # Email verification handler

/groups                 # My Groups dashboard (protected)
/groups/new             # Create new group (protected)
/groups/:groupId        # Group detail - redirects to /messages
/groups/:groupId/messages    # Group messages (protected, role-based)
/groups/:groupId/members     # Group members (protected, role-based)
/groups/:groupId/invitations # Pending invitations (protected, admin only)
/groups/:groupId/audit       # Audit log (protected, admin only)
/groups/:groupId/settings    # Group settings (protected, admin only)

/settings               # User settings (protected)
/settings/security      # Password, 2FA settings (protected)

/invite/:token          # Invitation acceptance handler

# Super-admin only
/admin/groups           # All groups view
/admin/users            # All users view
```

### 11.2 Navigation Structure

**Header (authenticated):**

- Logo/Home link → /groups
- "My Groups" → /groups
- User menu dropdown:
  - Settings → /settings
  - Logout

**Header (unauthenticated):**

- Logo/Home link → /login
- Login → /login
- Register → /register

**Group sub-navigation (within /groups/:groupId/\*):**

- Messages (all members)
- Members (all members, limited actions for non-admins)
- Invitations (admins only)
- Audit Log (admins only)
- Settings (admins only)

---

## 12. Project Structure

```
/
├── convex/
│   ├── _generated/           # Convex generated files
│   ├── schema.ts             # Database schema
│   ├── auth.ts               # Convex Auth configuration
│   ├── users.ts              # User mutations/queries
│   ├── groups.ts             # Group mutations/queries
│   ├── memberships.ts        # Membership mutations/queries
│   ├── invitations.ts        # Invitation mutations/queries
│   ├── messages.ts           # Message mutations/queries
│   ├── auditLogs.ts          # Audit log queries
│   └── lib/
│       ├── permissions.ts    # Permission check helpers
│       └── validators.ts     # Shared validation logic
│
├── src/
│   ├── main.tsx              # App entry point
│   ├── App.tsx               # Root component with providers
│   ├── router.tsx            # TanStack Router configuration
│   ├── routeTree.gen.ts      # Generated route tree
│   │
│   ├── pages/
│   │   ├── index.tsx         # Landing/redirect
│   │   ├── login.tsx
│   │   ├── register.tsx
│   │   ├── forgot-password.tsx
│   │   ├── reset-password.tsx
│   │   ├── verify-email.tsx
│   │   ├── invite.tsx
│   │   │
│   │   ├── groups/
│   │   │   ├── index.tsx     # My Groups list
│   │   │   ├── new.tsx       # Create group
│   │   │   └── $groupId/
│   │   │       ├── index.tsx # Redirect to messages
│   │   │       ├── messages.tsx
│   │   │       ├── members.tsx
│   │   │       ├── invitations.tsx
│   │   │       ├── audit.tsx
│   │   │       └── settings.tsx
│   │   │
│   │   ├── settings/
│   │   │   ├── index.tsx     # General settings
│   │   │   └── security.tsx  # Password, 2FA
│   │   │
│   │   └── admin/
│   │       ├── groups.tsx    # Super-admin: all groups
│   │       └── users.tsx     # Super-admin: all users
│   │
│   ├── features/
│   │   ├── auth/
│   │   │   ├── components/
│   │   │   │   ├── LoginForm.tsx
│   │   │   │   ├── RegisterForm.tsx
│   │   │   │   ├── ForgotPasswordForm.tsx
│   │   │   │   ├── ResetPasswordForm.tsx
│   │   │   │   ├── TotpSetup.tsx
│   │   │   │   ├── TotpVerify.tsx
│   │   │   │   └── GoogleOAuthButton.tsx
│   │   │   ├── hooks/
│   │   │   │   └── useAuth.ts
│   │   │   └── utils/
│   │   │       └── passwordValidation.ts
│   │   │
│   │   ├── groups/
│   │   │   ├── components/
│   │   │   │   ├── GroupList.tsx
│   │   │   │   ├── GroupCard.tsx
│   │   │   │   ├── CreateGroupForm.tsx
│   │   │   │   └── GroupSettings.tsx
│   │   │   └── hooks/
│   │   │       └── useGroups.ts
│   │   │
│   │   ├── members/
│   │   │   ├── components/
│   │   │   │   ├── MemberList.tsx
│   │   │   │   ├── MemberRow.tsx
│   │   │   │   ├── RoleSelector.tsx
│   │   │   │   └── InviteForm.tsx
│   │   │   └── hooks/
│   │   │       └── useMembers.ts
│   │   │
│   │   ├── messages/
│   │   │   ├── components/
│   │   │   │   ├── MessageList.tsx
│   │   │   │   ├── MessageItem.tsx
│   │   │   │   └── MessageInput.tsx
│   │   │   └── hooks/
│   │   │       └── useMessages.ts
│   │   │
│   │   └── audit/
│   │       ├── components/
│   │       │   ├── AuditLogList.tsx
│   │       │   └── AuditLogEntry.tsx
│   │       └── hooks/
│   │           └── useAuditLog.ts
│   │
│   └── shared/
│       ├── components/
│       │   ├── ProtectedWithRedirect.tsx
│       │   ├── ProtectedWithLogin.tsx
│       │   ├── GroupRoleGuard.tsx
│       │   ├── SuperAdminGuard.tsx
│       │   ├── Layout.tsx
│       │   ├── Header.tsx
│       │   ├── PasswordConfirmDialog.tsx
│       │   └── Loading.tsx
│       ├── hooks/
│       │   ├── useCurrentUser.ts
│       │   └── usePasswordConfirm.ts
│       └── utils/
│           └── formatters.ts
│
├── public/
├── index.html
├── vite.config.ts
├── tsconfig.json
├── package.json
└── .env.local              # CONVEX_DEPLOYMENT, etc.
```

---

## 13. Implementation Phases

Each phase is independently deployable and testable. Commit after each phase.

### Phase 1: Project Setup & Convex Init

**Goal:** Bootstrapped project with Convex connected

**Tasks:**

1. Create Vite + React + TypeScript project
2. Install dependencies:
   - `convex`
   - `@tanstack/react-router`
   - `@convex-dev/auth` (Convex Auth)
3. Initialize Convex: `npx convex dev`
4. Set up Convex Auth with email provider
5. Create basic schema (users table only)
6. Create TanStack Router boilerplate
7. Create minimal Layout and Loading components
8. Verify hot reload and Convex sync working

**Deliverables:**

- Working dev environment
- Convex dashboard accessible
- Basic routing working

---

### Phase 2: Email/Password Authentication

**Goal:** Users can register, verify email, and log in

**Tasks:**

1. Implement registration form with password validation
2. Implement email verification flow
3. Implement login form
4. Implement forgot password flow
5. Implement reset password flow
6. Create useAuth hook
7. Create ProtectedWithRedirect component
8. Create ProtectedWithLogin component

**Deliverables:**

- Full email/password auth flow
- Protected routes working
- User can access protected dashboard

---

### Phase 3: Google OAuth

**Goal:** Users can sign in with Google

**Tasks:**

1. Configure Google OAuth in Convex Auth
2. Create GoogleOAuthButton component
3. Implement account linking flow
4. Handle new user vs. existing user scenarios
5. Test OAuth + email/password on same account

**Deliverables:**

- Google sign-in working
- Account linking working

---

### Phase 4: User Settings & Password Confirmation

**Goal:** Users can manage their account

**Tasks:**

1. Create settings page layout
2. Implement PasswordConfirmDialog component
3. Implement password change (with confirmation)
4. Implement email change (with confirmation + re-verification)
5. Create user profile display

**Deliverables:**

- Settings page functional
- Password confirmation pattern established

---

### Phase 5: TOTP Two-Factor Authentication

**Goal:** Users can enable/disable 2FA

**Tasks:**

1. Implement TOTP secret generation
2. Create QR code display for authenticator apps
3. Implement TOTP verification during login
4. Implement 2FA enable flow (with password confirm)
5. Implement 2FA disable flow (with password + TOTP confirm)
6. Update login flow to check for 2FA

**Deliverables:**

- 2FA fully functional
- Login with 2FA working

---

### Phase 6: Groups - Basic CRUD

**Goal:** Users can create and view groups

**Tasks:**

1. Add groups and groupMemberships tables to schema
2. Implement group creation mutation
3. Implement "My Groups" query (active + removed)
4. Create GroupList component
5. Create CreateGroupForm component
6. Create group detail page layout

**Deliverables:**

- Users can create groups
- Users can see their groups
- Creator is auto-admin

---

### Phase 7: Permissions & Role Management

**Goal:** Role-based access control working

**Tasks:**

1. Create permission check helpers in Convex
2. Implement role change mutation (with last-admin check)
3. Create MemberList component
4. Create RoleSelector component
5. Implement self-leave functionality
6. Create GroupRoleGuard component

**Deliverables:**

- Admins can change roles
- Last admin cannot leave
- Role-based UI rendering

---

### Phase 8: Invitation System

**Goal:** Admins can invite users to groups

**Tasks:**

1. Add invitations table to schema
2. Implement invite creation mutation
3. Implement invite acceptance (registered users)
4. Implement invite acceptance (unregistered users → registration)
5. Implement invite revocation
6. Create InviteForm component
7. Create pending invitations list
8. Send invitation emails via Resend

**Deliverables:**

- Full invitation flow working
- Email delivery working

---

### Phase 9: Messaging System

**Goal:** Demo feature for group collaboration

**Tasks:**

1. Add messages table to schema
2. Implement message creation mutation (with role check)
3. Implement message listing query (with role check)
4. Create MessageList component with pagination
5. Create MessageInput component
6. Create MessageItem component
7. Handle "Deleted User" display for soft-deleted authors

**Deliverables:**

- Admins/editors can post messages
- All active members can view messages
- Real-time updates working

---

### Phase 10: Audit Logging

**Goal:** Track membership changes

**Tasks:**

1. Add auditLogs table to schema
2. Add audit logging to all membership mutations
3. Create AuditLogList component
4. Create AuditLogEntry component
5. Implement audit log query (admin only)

**Deliverables:**

- All membership events logged
- Admins can view audit log

---

### Phase 11: Group Soft Delete

**Goal:** Admins can archive groups

**Tasks:**

1. Implement group soft delete mutation
2. Update all queries to respect soft-deleted status
3. Update UI to show soft-deleted indicator
4. Removed members see only group name

**Deliverables:**

- Groups can be soft-deleted
- Data preserved but inaccessible

---

### Phase 12: User Account Deletion

**Goal:** Users can delete their accounts

**Tasks:**

1. Implement pre-deletion checks (no sole admin roles)
2. Implement soft delete mutation
3. Anonymize user data ("Deleted User {id}")
4. Update message display for deleted users
5. Block login for deleted users

**Deliverables:**

- Account deletion working
- PII removed, data preserved

---

### Phase 13: Super-Admin System

**Goal:** System administrators can manage everything

**Tasks:**

1. Add isSuperAdmin field check to queries/mutations
2. Create "All Groups" view for super-admins
3. Implement group restoration
4. Implement hard delete for groups
5. Implement hard delete for users
6. Create SuperAdminGuard component
7. Add super-admin routes

**Deliverables:**

- Super-admin powers working
- Soft-deleted groups can be restored

---

### Phase 14: Polish & Edge Cases

**Goal:** Production-ready quality

**Tasks:**

1. Add comprehensive error handling
2. Add form validation feedback
3. Handle loading states consistently
4. Test all edge cases:
   - Last admin scenarios
   - Concurrent role changes
   - Deleted user displays
   - OAuth edge cases
5. Add proper TypeScript types throughout
6. Clean up any TODO comments

**Deliverables:**

- Robust error handling
- Consistent UX
- No known bugs

---

### Phase 15: Deployment

**Goal:** Live on Vercel + Convex Cloud

**Tasks:**

1. Configure Convex production deployment
2. Set up Resend production API key
3. Configure Google OAuth for production domain
4. Deploy to Vercel
5. Configure environment variables
6. Test all flows in production

**Deliverables:**

- Live, working application
- All features functional in production

---

## 14. Future Considerations

The following features were discussed but deferred:

**Authentication:**

- Session management (view/revoke active sessions)
- Rate limiting for login attempts
- 2FA enforcement by group admins
- Passkey support
- Email OTP as 2FA method

**Groups:**

- Sub-groups / nested hierarchy
- Invitation expiry
- Self-request to join (vs. admin-initiated only)

**System:**

- Super-admin promotion via UI
- Comprehensive admin dashboard
- Analytics and usage metrics

**Messages:**

- Edit/delete functionality
- Markdown support
- Rich media attachments
- Reactions and comments

---

## Appendix A: Convex Auth Configuration

```typescript
// convex/auth.ts
import { convexAuth } from "@convex-dev/auth/server";
import { Password } from "@convex-dev/auth/providers/Password";
import Google from "@auth/core/providers/google";

export const { auth, signIn, signOut, store } = convexAuth({
  providers: [
    Password({
      verify: async (credentials) => {
        // Custom password validation
        const { email, password } = credentials;
        // Validation logic here
      },
    }),
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    }),
  ],
});
```

## Appendix B: Environment Variables

```bash
# .env.local

# Convex
CONVEX_DEPLOYMENT=your-deployment-name

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Resend (for email)
RESEND_API_KEY=your-resend-api-key
```

## Appendix C: Password Validation Regex

```typescript
// Minimum 12 characters
// At least one letter (a-z, A-Z)
// At least one number (0-9)
// At least one symbol

const PASSWORD_REGEX =
  /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{12,}$/;

function validatePassword(password: string): {
  valid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  if (password.length < 12) {
    errors.push("Password must be at least 12 characters");
  }
  if (!/[a-zA-Z]/.test(password)) {
    errors.push("Password must contain at least one letter");
  }
  if (!/\d/.test(password)) {
    errors.push("Password must contain at least one number");
  }
  if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
    errors.push("Password must contain at least one symbol");
  }

  return { valid: errors.length === 0, errors };
}
```

---

_Specification Version: 1.0_
_Last Updated: January 2025_
_Author: Claude (based on interview with Alex)_
